# Безопасность сайта рецептов

## Обзор безопасности

Сайт рецептов разработан с учетом лучших практик безопасности для защиты от несанкционированного доступа и злоупотреблений.

## Уровни защиты

### 1. Аутентификация и авторизация

#### NextAuth.js

- Использует проверенную библиотеку NextAuth.js для управления сессиями
- JWT токены для безопасного хранения сессий
- Автоматическое истечение сессий

#### Ролевая модель

- Только пользователи с ролью `admin` имеют доступ к админ-панели
- Проверка роли на уровне компонентов и API routes
- Двойная проверка: клиентская и серверная

### 2. Защита админ-панели

#### Отсутствие веб-регистрации

- ❌ Удалена возможность создания администратора через веб-интерфейс
- ✅ Создание администратора только через командную строку
- ✅ Предотвращает несанкционированную регистрацию

#### Защищенные маршруты

- Все маршруты `/admin/*` защищены layout компонентом
- Автоматическое перенаправление неаутентифицированных пользователей
- Блокировка доступа для пользователей без роли администратора

### 3. API защита

#### Серверная валидация

- Все API routes проверяют аутентификацию через `getServerSession`
- Валидация роли администратора для операций записи
- Возврат 403 ошибки для неавторизованных запросов

#### Защищенные endpoints

```
POST /api/recipes - только для админов
POST /api/categories - только для админов
PUT /api/recipes/[id] - только для админов
DELETE /api/recipes/[id] - только для админов
```

### 4. Защита паролей

#### Хеширование

- Использование bcrypt с salt rounds = 12
- Пароли никогда не хранятся в открытом виде
- Невозможность восстановления исходного пароля

```typescript
const hashedPassword = await bcrypt.hash(password, 12);
```

### 5. База данных

#### Prisma ORM

- Автоматическая защита от SQL инъекций
- Типизированные запросы
- Безопасные транзакции

#### Модель пользователя

```prisma
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String    // Хешированный
  role          String    @default("user")
  // ...
}
```

### 6. CSRF защита

- NextAuth.js автоматически обеспечивает CSRF защиту
- Проверка CSRF токенов на всех формах
- Защита от межсайтовых запросов

## Процедуры безопасности

### Создание администратора

1. **Только через командную строку**:

   ```bash
   npm run create-admin
   ```

2. **Проверка существующих администраторов**:

   - Скрипт автоматически проверяет наличие существующих админов
   - Предотвращает создание дублей

3. **Валидация данных**:
   - Проверка формата email
   - Минимальная длина пароля (6 символов)
   - Обязательные поля

### Вход в систему

1. **Только через `/login`**
2. **Проверка учетных данных**:
   - Сравнение хешированных паролей
   - Проверка роли пользователя
3. **Создание безопасной сессии**

### Доступ к админ-панели

1. **Многоуровневая проверка**:

   - Layout компонент проверяет аутентификацию
   - Каждая страница проверяет роль
   - API routes дублируют проверки

2. **Автоматические перенаправления**:
   - Неаутентифицированные → `/login`
   - Не-администраторы → главная страница с сообщением

## Мониторинг и логирование

### Логирование ошибок

- Все ошибки аутентификации логируются
- Попытки несанкционированного доступа отслеживаются
- Ошибки базы данных записываются в консоль

### Мониторинг сессий

- NextAuth.js отслеживает активные сессии
- Автоматическое истечение неактивных сессий
- Защита от session hijacking

## Рекомендации по развертыванию

### Переменные окружения

```env
# Обязательно измените в продакшене!
NEXTAUTH_SECRET="secure-random-string-at-least-32-characters"
NEXTAUTH_URL="https://yourdomain.com"
DATABASE_URL="postgresql://..."
```

### HTTPS

- Обязательно используйте HTTPS в продакшене
- NextAuth.js требует HTTPS для безопасности
- Настройте SSL сертификаты

### База данных

- Используйте сильные пароли для БД
- Ограничьте сетевой доступ к БД
- Регулярные бэкапы

## Известные ограничения

1. **Нет восстановления пароля** - администратор должен быть пересоздан
2. **Нет блокировки аккаунта** - после множественных неудачных попыток входа
3. **Нет двухфакторной аутентификации** - можно добавить в будущем

## Аудит безопасности

### Регулярные проверки

- [ ] Обновление зависимостей
- [ ] Проверка логов на подозрительную активность
- [ ] Аудит ролей и разрешений
- [ ] Тестирование восстановления после инцидентов

### Инструменты

- `npm audit` - проверка уязвимостей зависимостей
- `eslint-plugin-security` - статический анализ кода
- Prisma Studio - мониторинг базы данных

## Контакты

При обнаружении уязвимостей безопасности, пожалуйста, свяжитесь с администратором системы.
